generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model AdminUser {
  id                       String            @id @default(uuid())
  email                    String            @unique
  password                 String
  name                     String?
  createdAt                DateTime          @default(now())
  reviewedTaxonomyRequests TaxonomyRequest[] @relation("TaxonomyReviewedBy")
}

model User {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())

  brandMemberships BrandMembership[]
  importJobs       ImportJob[]
  taxonomyRequests TaxonomyRequest[]
}

model BrandMembership {
  id      String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId  String @db.Uuid
  brandId String @db.Uuid
  role    Role   @default(viewer)

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([userId, brandId])
  @@index([brandId])
  @@index([userId])
}

model BrandInvite {
  id        String    @id @default(cuid())
  email     String
  tokenHash String    @unique
  brandId   String    @db.Uuid
  role      Role      @default(owner)
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([brandId])
}

/// *
///  * =========================
///  * Catalog models
///  * =========================
model Brand {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name       String
  slug       String   @unique
  websiteUrl String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  products         Product[]
  memberships      BrandMembership[]
  invites          BrandInvite[]
  importJobs       ImportJob[]
  taxonomyRequests TaxonomyRequest[]

  defaultCommissionRate Decimal? @db.Decimal(5, 4) // e.g. 0.08
  aovEstimate           Decimal? @db.Decimal(12, 2) // e.g. 65.00

  baseCountryCode    String?             @db.Char(2) // e.g. "GB", "FR", "AE"
  // optional, if you want to avoid mapping in code:
  baseRegion         Region? // enum: EUROPE, AFRICA, etc.
  adminNotifications AdminNotification[]

  // ✅ ADD THESE (opposite relations)
  affiliateClicks   AffiliateClick[]
  affiliateEarnings AffiliateEarning[]
  payouts           BrandPayout[]
}

model Category {
  id       String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name     String
  slug     String    @unique
  products Product[]
}

model Occasion {
  id   String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name String
  slug String @unique

  productOccasions ProductOccasion[]
}

model Material {
  id   String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name String
  slug String @unique

  productMaterials ProductMaterial[]
}

model Product {
  id              String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  brandId         String           @db.Uuid
  title           String
  slug            String
  currency        Currency         @default(GBP)
  sourceUrl       String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @default(now()) @updatedAt
  isActive        Boolean          @default(true)
  badges          Badge[]          @default([])
  categoryId      String?          @db.Uuid
  colour          String?
  note            String?
  price           Decimal?         @db.Decimal(10, 2)
  stock           Int?
  publishedAt     DateTime?
  affiliateUrl    String?
  productType     ProductType?
  brand           Brand            @relation(fields: [brandId], references: [id], onDelete: Cascade)
  category        Category?        @relation(fields: [categoryId], references: [id])
  images          ProductImage[]
  affiliateClicks AffiliateClick[]
  status          ProductStatus    @default(DRAFT)
  lastApprovedAt  DateTime?

  worldwideShipping Boolean                  @default(false)
  shippingCountries ProductShippingCountry[]

  productTags        ProductTag[]
  productMaterials   ProductMaterial[]
  productOccasions   ProductOccasion[]
  adminNotifications AdminNotification[]

  // (Optional but useful)
  submittedAt DateTime?
  reviewNote  String?

  @@unique([brandId, sourceUrl], name: "brandId_sourceUrl")
  @@index([brandId, slug])
  @@index([categoryId])
  @@index([affiliateUrl])
  @@index([productType])
}

model ProductImage {
  id        String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId String  @db.Uuid
  url       String
  sortOrder Int     @default(0)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model ImportJob {
  id              String   @id @default(cuid())
  type            String
  filename        String?
  status          String
  total           Int      @default(0)
  valid           Int      @default(0)
  invalid         Int      @default(0)
  createdBrands   Int      @default(0)
  createdProducts Int      @default(0)
  updatedProducts Int      @default(0)
  rowErrors       Json?
  meta            Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  brandId String? @db.Uuid
  userId  String? @db.Uuid
  brand   Brand?  @relation(fields: [brandId], references: [id])
  user    User?   @relation(fields: [userId], references: [id])

  @@index([brandId])
  @@index([userId])
}

model NewsletterSubscriber {
  id               String    @id @default(cuid())
  email            String    @unique
  source           String?
  createdAt        DateTime  @default(now())
  status           String    @default("pending")
  tags             String[]
  updatedAt        DateTime  @updatedAt
  confirmToken     String?   @unique
  confirmedAt      DateTime?
  unsubscribeToken String?   @unique
  unsubscribedAt   DateTime?
}

model BrandApplication {
  id          String                 @id @default(cuid())
  website     String?
  email       String
  notes       String?
  status      BrandApplicationStatus @default(new)
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  firstName   String
  lastName    String
  phone       String?
  socialMedia String?

  @@index([status, createdAt])
  @@index([email])
}

enum Role {
  owner
  admin
  editor
  viewer
  super_admin
}

enum Currency {
  GBP
  EUR
  CHF
  USD
}

enum Badge {
  bestseller
  new_in
  editor_pick
  modest_essential
  limited_stock
  sale
  ramadan_edit
  eid_edit
  workwear
  next_day
}

enum BrandApplicationStatus {
  new
  contacted
  invited
  onboarded
  rejected
}

model AffiliateClick {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId String?  @db.Uuid
  brandId   String   @db.Uuid
  clickedAt DateTime @default(now())

  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  brand   Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId, clickedAt])
  @@index([productId, clickedAt])
}

model AffiliateEarning {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  brandId   String   @db.Uuid
  month     DateTime // store as first day of month (e.g. 2026-02-01)
  amount    Decimal  @db.Decimal(12, 2)
  currency  Currency @default(GBP)
  reference String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([brandId, month])
  @@index([month])
}

model BrandPayout {
  id        String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  brandId   String       @db.Uuid
  month     DateTime
  status    PayoutStatus @default(pending)
  method    String?
  notes     String?
  updatedAt DateTime     @updatedAt
  createdAt DateTime     @default(now())

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([brandId, month])
  @@index([month])
}

enum PayoutStatus {
  pending
  approved
  paid
}

enum ProductType {
  ABAYA
  DRESS
  SKIRT
  TOP
  HIJAB
}

model WaitlistSubscriber {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  email     String   @unique
  createdAt DateTime @default(now())
}

enum ProductStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  NEEDS_CHANGES
  REJECTED
}

enum TaxonomyType {
  TAG
  MATERIAL
  OCCASION
}

enum TaxonomyRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model Tag {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())

  products ProductTag[]
}

model ProductTag {
  productId String @db.Uuid
  tagId     String @db.Uuid

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([productId, tagId])
  @@index([tagId])
  @@index([productId])
}

model ProductMaterial {
  productId  String @db.Uuid
  materialId String @db.Uuid

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  material Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@id([productId, materialId])
  @@index([materialId])
  @@index([productId])
}

model ProductOccasion {
  productId  String @db.Uuid
  occasionId String @db.Uuid

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  occasion Occasion @relation(fields: [occasionId], references: [id], onDelete: Cascade)

  @@id([productId, occasionId])
  @@index([occasionId])
  @@index([productId])
}

model TaxonomyRequest {
  id                String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  brandId           String                @db.Uuid
  userId            String                @db.Uuid
  type              TaxonomyType
  name              String
  slug              String
  status            TaxonomyRequestStatus @default(PENDING)
  reason            String?
  createdAt         DateTime              @default(now())
  reviewedAt        DateTime?
  reviewedByAdminId String? // ✅ add this back
  reviewedByAdmin   AdminUser?            @relation("TaxonomyReviewedBy", fields: [reviewedByAdminId], references: [id])

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([type, slug]) // prevents duplicate requests for same slug
  @@index([brandId, status, createdAt])
  @@index([type, status])
  @@index([reviewedByAdminId])
}

model ProductShippingCountry {
  productId   String @db.Uuid
  countryCode String @db.Char(2) // ISO-2

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([productId, countryCode])
  @@index([countryCode])
  @@index([productId])
}

model AdminNotification {
  id        String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type      AdminNotificationType // e.g. "PRODUCT_SUBMITTED", "TAXONOMY_REQUEST"
  brandId   String?               @db.Uuid
  productId String?               @db.Uuid
  createdAt DateTime              @default(now())
  readAt    DateTime?

  brand   Brand?   @relation(fields: [brandId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([type, createdAt])
  @@index([readAt])
}

enum AdminNotificationType {
  PRODUCT_SUBMITTED
  TAXONOMY_REQUEST
}

enum Region {
  EUROPE
  AFRICA
  ASIA
  NORTH_AMERICA
  SOUTH_AMERICA
  OCEANIA
  MIDDLE_EAST
}
